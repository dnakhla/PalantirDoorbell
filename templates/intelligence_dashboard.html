<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoorBell-antir - Surveillance Dashboard</title>
    <script src="https://unpkg.com/vis-timeline@7.7.3/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <link href="https://unpkg.com/vis-timeline@7.7.3/styles/vis-timeline-graph2d.min.css" rel="stylesheet"
        type="text/css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: #f8f8f8;
            color: #333;
            font-size: 16px;
            line-height: 1.6;
            position: relative;
        }

        /* Satirical overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 30%, rgba(255, 0, 0, 0.02) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(0, 0, 0, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }

        .street-art-header {
            background: #fff;
            padding: 15px 0;
            position: relative;
            overflow: hidden;
        }

        .street-art-header::before {
            content: 'BIG BROTHER\'S WATCHING!';
            position: absolute;
            top: 22px;
            left: 130px;
            font-size: 12px;
            color: #ff0000;
            font-weight: 900;
            transform: rotate(-15deg);
            font-family: 'Courier New', monospace;
        }

        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-size: 20px;
            font-weight: 900;
            color: #000;
            text-decoration: none;
            position: relative;
        }

        .logo::after {
            content: 'üëÅÔ∏è';
            position: absolute;
            top: -5px;
            right: -25px;
            font-size: 16px;
            animation: blink 2s infinite;
        }

        @keyframes blink {

            0%,
            90% {
                opacity: 1;
            }

            95% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 12px;
            color: #666;
        }

        .warning-ticker {
            background: #ff0000;
            color: #fff;
            padding: 5px 0;
            overflow: hidden;
            white-space: nowrap;
            font-size: 12px;
            border-bottom: 3px solid #000;
            border-top: 3px solid #000;
        }

        .ticker-text {
            display: inline-block;
            animation: scroll 25s linear infinite;
            font-weight: 700;
        }

        @keyframes scroll {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            position: relative;
            z-index: 2;
        }

        .surveillance-feed {
            background: #fff;
            border: 3px solid #000;
            position: relative;
            margin-bottom: 30px;
        }

        .surveillance-feed::before {
            content: 'LIVE SURVEILLANCE FEED';
            position: absolute;
            top: -15px;
            left: 20px;
            background: #ff0000;
            color: #fff;
            padding: 0 15px;
            font-size: 12px;
            font-weight: 700;
            transform: rotate(-1deg);
        }

        .feed-container {
            width: 100%;
            height: 0;
            padding-bottom: 56.25%;
            /* 16:9 aspect ratio */
            background: #000;
            position: relative;
            overflow: hidden;
            border: 2px solid #333;
        }

        .feed-container::before {
            content: 'PRIVACY VIOLATION IN PROGRESS';
            position: absolute;
            top: 10px;
            left: 10px;
            color: #ff0000;
            font-size: 11px;
            font-weight: 700;
            background: rgba(0, 0, 0, 0.8);
            padding: 3px 8px;
            animation: blink 1s infinite;
            z-index: 10;
        }

        .feed-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* Maintain aspect ratio */
            filter: grayscale(20%) contrast(1.1);
            image-rendering: -webkit-optimize-contrast;
            image-rendering: optimize-contrast;
        }

        .feed-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #fff;
            font-size: 12px;
            font-weight: 700;
            background: rgba(0, 0, 0, 0.7);
            padding: 3px 8px;
            z-index: 10;
        }

        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            border: 2px solid #ff0000;
            opacity: 0.6;
            z-index: 5;
        }

        .crosshair::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background: #ff0000;
            transform: translateY(-50%);
        }

        .crosshair::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            width: 2px;
            height: 100%;
            background: #ff0000;
            transform: translateX(-50%);
        }


        .subjects-section {
            background: #fff;
            border: 2px solid #000;
            position: relative;
            padding: 20px;
            height: 400px;
        }


        .subjects-section::before {
            content: 'QUALIFIED SUBJECTS (3+ IMAGES)';
            position: absolute;
            top: -12px;
            left: 20px;
            background: #000;
            color: #fff;
            padding: 0 15px;
            font-size: 12px;
            font-weight: 700;
            transform: rotate(1deg);
            z-index: 1000;
            display: block;
        }

        .subjects-section::after {
            content: 'EVIDENCE COLLECTED';
            position: absolute;
            top: 30px;
            right: 20px;
            font-size: 32px;
            color: #ccc;
            font-weight: 700;
            transform: rotate(-10deg);
        }

        .subjects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
            min-width: 100%;
            height: 100%;
            overflow-y: hidden;
        }

        .subject-card {
            position: relative;
            background: #f8f8f8;
            border: 2px solid #333;
            cursor: pointer;
            transition: transform 0.2s;
            padding-bottom: 60px;
            height: 200px;
        }

        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff0000;
            color: #fff;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: #cc0000;
            transform: scale(1.1);
        }

        .subject-card:hover .delete-btn {
            opacity: 1;
        }

        .subject-card:hover {
            transform: rotate(2deg) scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .subject-card img {
            width: 100%;
            height: 150px;
            object-fit: contain;
            /* Maintain aspect ratio */
            filter: grayscale(50%) contrast(1.1);
            transition: opacity 0.5s ease-in-out;
            background: #000;
            /* Black background for letterboxing */
        }

        .subject-timestamp {
            position: absolute;
            bottom: 25px;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            font-size: 9px;
            padding: 2px 5px;
            text-align: center;
        }

        .subject-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 8px;
        }

        .subject-nickname {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 4px;
            color: #ff0000;
        }

        .subject-analysis {
            font-size: 10px;
            line-height: 1.2;
            color: #ccc;
            margin-bottom: 4px;
        }

        .detection-count {
            font-size: 9px;
            color: #ffaa00;
            font-weight: 700;
        }

        .demographics-info {
            display: flex;
            gap: 4px;
            margin: 2px 0;
            flex-wrap: wrap;
        }

        .gender-tag,
        .skin-tone-tag {
            font-size: 8px;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .gender-tag {
            background: #004080;
            color: #fff;
        }

        .skin-tone-tag {
            background: #800040;
            color: #fff;
        }

        .threat-indicator {
            position: absolute;
            top: 3px;
            right: 3px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #fff;
        }

        .threat-low {
            background: #00aa00;
        }

        .threat-medium {
            background: #ffaa00;
        }

        .threat-high {
            background: #ff0000;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .analytics-section {
            background: #fff;
            border: 2px solid #000;
            padding: 20px;
            position: relative;
            margin-bottom: 20px;
        }

        .analytics-section::before {
            content: 'SUBJECT ANALYTICS';
            position: absolute;
            top: -12px;
            left: 20px;
            background: #000;
            color: #fff;
            padding: 0 15px;
            font-size: 12px;
            font-weight: 700;
            transform: rotate(1deg);
        }

        .analytics-section::after {
            content: 'BEHAVIORAL PATTERNS';
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 10px;
            color: #ccc;
            font-weight: 700;
            transform: rotate(-10deg);
        }

        .analytics-section h3 {
            font-size: 14px;
            font-weight: 900;
            margin-bottom: 15px;
            color: #000;
            text-transform: uppercase;
        }

        .pie-chart-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 180px;
            margin: 20px 0;
        }

        .pie-chart-legend {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
            font-size: 11px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            border: 1px solid #333;
            flex-shrink: 0;
        }

        .legend-label {
            font-size: 10px;
            color: #333;
            font-weight: 600;
            flex: 1;
        }

        .legend-count {
            font-size: 9px;
            color: #666;
            font-weight: bold;
        }

        .chart-title {
            font-size: 14px;
            font-weight: 700;
            color: #000;
            text-align: center;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .analysis-panel {
            background: #fff;
            border: 2px dashed #ff0000;
            padding: 20px;
            position: relative;
            transform: rotate(-0.5deg);
        }

        .analysis-panel::before {
            content: '24H PARANOIA REPORT';
            position: absolute;
            top: -12px;
            left: 20px;
            background: #ff0000;
            color: #fff;
            padding: 0 15px;
            font-size: 12px;
            font-weight: 700;
            transform: rotate(1deg);
        }

        .analysis-title {
            font-size: 18px;
            font-weight: 900;
            margin-bottom: 15px;
            color: #000;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: #f8f8f8;
            border: 1px solid #333;
            padding: 15px;
            text-align: center;
            position: relative;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 900;
            color: #ff0000;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .activity-log {
            background: #f8f8f8;
            border: 1px solid #333;
            padding: 15px;
            margin-top: 20px;
        }

        .activity-log h4 {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #000;
        }

        .activity-item {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            position: relative;
            padding-left: 15px;
        }

        .activity-item::before {
            content: '‚Üí';
            position: absolute;
            left: 0;
            color: #ff0000;
            font-weight: 700;
        }

        .hover-analysis {
            position: absolute;
            background: #fff;
            border: 3px solid #000;
            padding: 20px;
            min-width: 300px;
            max-width: 400px;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: none;
            transform: rotate(-1deg);
        }

        .hover-analysis::before {
            content: 'SUBJECT ANALYSIS';
            position: absolute;
            top: -12px;
            left: 20px;
            background: #000;
            color: #fff;
            padding: 0 15px;
            font-size: 12px;
            font-weight: 700;
        }

        .analysis-image {
            width: 100%;
            height: 150px;
            object-fit: contain;
            /* Maintain aspect ratio */
            border: 2px solid #333;
            margin-bottom: 15px;
            filter: grayscale(30%) contrast(1.1);
            background: #000;
            /* Black background for letterboxing */
        }

        .analysis-content h3 {
            font-size: 16px;
            font-weight: 900;
            margin-bottom: 10px;
            color: #000;
        }

        .analysis-detail {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .analysis-detail strong {
            color: #000;
        }

        .subject-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 15px;
        }

        .subject-gallery img {
            width: 100%;
            height: 60px;
            object-fit: contain;
            /* Maintain aspect ratio */
            border: 1px solid #333;
            filter: grayscale(50%);
            background: #000;
            /* Black background for letterboxing */
        }

        .sarcasm-note {
            font-size: 10px;
            color: #999;
            font-style: italic;
            margin-top: 10px;
            text-align: center;
        }

        .sarcasm-note::before {
            content: '* ';
            color: #ff0000;
        }

        .loading-subjects {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
            min-width: 50rem;
        }

        .loading-timeline::before {
            content: 'SCANNING FOR SUSPICIOUS ACTIVITY...';
            display: block;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .sidebar {
                order: -1;
            }
        }

        /* Expanded Card Modal */
        .expanded-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .expanded-modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 0;
            border: 3px solid #000;
            width: 80%;
            max-width: 800px;
            position: relative;
            transform: rotate(-0.5deg);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            color: #000;
        }

        .expanded-card {
            padding: 30px;
        }

        .expanded-main-image {
            width: 100%;
            height: 400px;
            margin-bottom: 20px;
            border: 2px solid #333;
            overflow: hidden;
        }

        .expanded-main-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* Maintain aspect ratio */
            filter: grayscale(20%) contrast(1.1);
            background: #000;
            /* Black background for letterboxing */
        }

        .expanded-info {
            background: #f8f8f8;
            padding: 20px;
            border: 2px solid #333;
            margin-bottom: 20px;
            position: relative;
        }

        .expanded-info::before {
            content: 'SUBJECT ANALYSIS';
            position: absolute;
            top: -12px;
            left: 20px;
            background: #000;
            color: #fff;
            padding: 0 15px;
            font-size: 12px;
            font-weight: 700;
        }

        .expanded-nickname {
            font-size: 24px;
            font-weight: 900;
            color: #ff0000;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .expanded-analysis {
            font-size: 16px;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .expanded-count {
            font-size: 14px;
            color: #ffaa00;
            font-weight: 700;
        }

        .expanded-main-image::after {
            content: 'GIF MODE';
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.8);
            color: #fff;
            padding: 4px 8px;
            font-size: 10px;
            font-weight: 700;
            border: 1px solid #fff;
        }

        @media (max-width: 768px) {
            .subjects-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
            }

            .feed-container {
                padding-bottom: 75%;
                /* 4:3 aspect ratio for mobile */
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .expanded-modal-content {
                width: 95%;
                margin: 10% auto;
            }

            .expanded-main-image {
                height: 250px;
            }
        }

        .image-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 200px;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid #ccc;
            color: #fff;
            padding: 8px;
            font-size: 11px;
            font-family: Arial, sans-serif;
        }

        .overlay-content {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .overlay-header {
            border-bottom: 1px solid #ccc;
            padding-bottom: 4px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .overlay-subject-name {
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .threat-badge {
            font-size: 8px;
            padding: 2px 4px;
            border: 1px solid;
            background: rgba(0, 0, 0, 0.7);
        }

        .threat-low {
            color: #90EE90;
            border-color: #90EE90;
        }

        .threat-medium {
            color: #FFD700;
            border-color: #FFD700;
        }

        .threat-high {
            color: #FF6B6B;
            border-color: #FF6B6B;
        }

        .overlay-details {
            font-size: 10px;
            line-height: 1.3;
        }

        .detail-item {
            margin-bottom: 3px;
            display: flex;
            justify-content: space-between;
        }

        .label {
            color: #ccc;
            text-transform: uppercase;
            font-weight: bold;
            font-size: 9px;
        }

        .value {
            text-align: right;
            color: #fff;
            font-size: 10px;
        }

        .description {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid #666;
            font-size: 9px;
            color: #ddd;
        }

        .pending-detection {
            position: relative;
            opacity: 0.7;
            border: 2px dashed #ff6600 !important;
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0%, 100% { border-color: #ff6600; }
            50% { border-color: #ffaa00; }
        }

        .pending-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 102, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }

        .processing-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #ff6600;
            border-top: 3px solid #ffaa00;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pending-text {
            font-size: 10px;
            font-weight: bold;
            color: #ff6600;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
    </style>
</head>

<body>
    <header class="street-art-header">
        <div class="header-container">
            <a href="/" class="logo">DoorBell-antir</a>
            <div class="status-bar">
                <span id="subject-count">0 SUBJECTS UNDER SURVEILLANCE</span>
                <span id="current-time"></span>
            </div>
        </div>
    </header>

    <div class="warning-ticker">
        <div class="ticker-text">
            PRIVACY IS CHEATING ‚Ä¢ EVERYONE IS SUSPICIOUS ‚Ä¢ NORMALIZE SURVEILLANCE ‚Ä¢ SAFETY OVER PRIVACY ‚Ä¢
        </div>
    </div>

    <div class="main-container">
        <main class="surveillance-main">
            <div class="surveillance-feed">
                <div class="feed-container">
                    <img src="/api/video_feed" alt="Live surveillance feed">
                    <div class="feed-overlay" id="live-timestamp">LIVE</div>
                    <!-- <div class="crosshair"></div> -->
                </div>

            </div>

            <div class="subjects-section">
                <div class="subjects-grid" id="subjects-grid">
                    <!-- Subject cards will be populated here -->
                </div>
            </div>
        </main>

        <aside class="sidebar">
            <div class="analysis-panel">
                <h2 class="analysis-title">Dystopian Analytics</h2>
                <div class="stats-grid">
                    <!-- Gender Chart -->
                    <div class="stat-item">
                        <h3 class="chart-title">Gender</h3>
                        <div class="pie-chart-container">
                            <canvas id="genderChart" width="120" height="120"></canvas>
                        </div>
                        <div class="pie-chart-legend" id="genderLegend">
                            <!-- Gender legend will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Skin Tone Chart -->
                    <div class="stat-item">
                        <h3 class="chart-title">Skin Tone</h3>
                        <div class="pie-chart-container">
                            <canvas id="skinToneChart" width="120" height="120"></canvas>
                        </div>
                        <div class="pie-chart-legend" id="skinToneLegend">
                            <!-- Skin tone legend will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Hidden elements for JavaScript compatibility -->
                <div style="display: none;">
                    <span id="total-subjects">0</span>
                    <span id="threat-count">0</span>
                    <span id="privacy-violations">0</span>
                    <span id="ai-analyses">0</span>
                </div>

                <div class="activity-log">
                    <h4>Detection Log</h4>
                    <div style="margin-bottom: 15px;">
                        <button onclick="clearLogs()"
                            style="background: #ff0000; color: white; border: none; padding: 5px 10px; font-size: 10px; cursor: pointer; margin-right: 10px;">CLEAR
                            LOGS</button>
                        <button onclick="clearTimeline()"
                            style="background: #000; color: white; border: none; padding: 5px 10px; font-size: 10px; cursor: pointer;">CLEAR
                            TIMELINE</button>
                    </div>
                    <div id="activity-list">
                        <div class="activity-item">System initialized - awaiting detections...</div>
                    </div>
                </div>


                <div class="sarcasm-note">
                    Remember: Everyone is guilty of something
                </div>
            </div>
        </aside>
    </div>

    <!-- Hover Analysis Popup -->
    <div class="hover-analysis" id="hover-analysis">
        <div class="analysis-content">
            <img class="analysis-image" id="analysis-image" src="" alt="Subject">
            <h3 id="analysis-title">Subject Analysis</h3>
            <div class="analysis-detail"><strong>Analysis:</strong> <span id="ai-paranoia">Loading...</span></div>
            <div class="analysis-detail"><strong>Times Spotted:</strong> <span id="detection-count">1</span></div>

            <div class="subject-gallery" id="subject-gallery">
                <!-- Subject images will be populated here -->
            </div>

            <div class="sarcasm-note">
                AI-generated paranoia for your viewing pleasure
            </div>
        </div>
    </div>

    <script>
        let timelineData = [];
        let currentSubjects = new Map();

        // Update time
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString();
            document.getElementById('live-timestamp').textContent = now.toLocaleTimeString();
        }

        // Load surveillance data
        // WebSocket for real-time updates
        let websocket = null;

        function connectWebSocket() {
            const wsUrl = `ws://${window.location.host}/ws`;
            websocket = new WebSocket(wsUrl);

            websocket.onopen = function (event) {
                console.log('WebSocket connected for real-time updates');
            };

            websocket.onmessage = function (event) {
                const message = JSON.parse(event.data);
                if (message.type === 'profiles_update') {
                    console.log('Received profile update via WebSocket');
                    processProfileData(message.data);
                }
            };

            websocket.onclose = function (event) {
                console.log('WebSocket disconnected, attempting to reconnect...');
                setTimeout(connectWebSocket, 3000);
            };

            websocket.onerror = function (error) {
                console.error('WebSocket error:', error);
            };
        }

        function processProfileData(profiles) {
            // Process profiles into grouped timeline data
            timelineData = [];
            console.log('Processing profiles:', profiles.length);
            profiles.forEach(profile => {
                console.log('Profile:', profile.id, 'Images:', profile.images.length);
                // Only include subjects with at least 1 image
                if (profile.images.length < 1) {
                    console.log('Skipping profile with no images:', profile.id);
                    return;
                }

                // Extract AI analysis from simplified structure
                let analysisText = "Analysis pending...";
                let nickname = `Subject ${profile.id.substring(0, 8)}`;

                if (profile.ai_analysis && profile.ai_analysis.comprehensive_analysis) {
                    if (profile.ai_analysis.comprehensive_analysis.summary) {
                        analysisText = profile.ai_analysis.comprehensive_analysis.summary;
                    } else if (profile.ai_analysis.comprehensive_analysis.nickname) {
                        analysisText = profile.ai_analysis.comprehensive_analysis.nickname;
                    }

                    if (profile.ai_analysis.comprehensive_analysis.nickname) {
                        nickname = profile.ai_analysis.comprehensive_analysis.nickname;
                    }
                }

                // Create one entry per profile (grouped by person)
                timelineData.push({
                    id: profile.id,
                    time: new Date(profile.last_seen).toLocaleTimeString(),
                    date: new Date(profile.last_seen).toLocaleDateString(),
                    type: 'person',
                    nickname: nickname,
                    analysis: analysisText,
                    images: profile.images || [],
                    totalAppearances: profile.total_appearances || 1,
                    firstSeen: profile.first_seen,
                    lastSeen: profile.last_seen,
                    threatLevel: 'low', // Default
                    ai_analysis: profile.ai_analysis // Include full AI analysis for demographics
                });
            });

            // Update all displays
            console.log('Final timelineData:', timelineData.length, 'items');
            // updateTimelineDisplay(); // Function doesn't exist - removing for now
            updateAnalyticsChart(); // Use correct function name
            updateDemographicsDisplay(); // Add demographics display
            renderSubjects(); // Use correct function name
        }

        async function loadSurveillanceData() {
            try {
                const response = await fetch('/api/profiles');
                const profiles = await response.json();
                processProfileData(profiles);

                // Process profiles into grouped timeline data
                timelineData = [];
                profiles.forEach(profile => {
                    // Only include subjects with at least 2 images
                    if (profile.images.length < 2) {
                        return;
                    }

                    // Extract AI analysis from simplified structure
                    let analysisText = "Analysis pending...";
                    let nickname = `Subject ${profile.id.substring(0, 8)}`;

                    if (profile.ai_analysis && profile.ai_analysis.comprehensive_analysis) {
                        if (profile.ai_analysis.comprehensive_analysis.summary) {
                            analysisText = profile.ai_analysis.comprehensive_analysis.summary;
                        } else if (profile.ai_analysis.comprehensive_analysis.nickname) {
                            analysisText = profile.ai_analysis.comprehensive_analysis.nickname;
                        }

                        if (profile.ai_analysis.comprehensive_analysis.nickname) {
                            nickname = profile.ai_analysis.comprehensive_analysis.nickname;
                        }
                    }

                    // Create one entry per profile (grouped by person)
                    timelineData.push({
                        id: profile.id,
                        nickname: nickname,
                        mainImage: profile.images[profile.images.length - 1], // Most recent image
                        timestamp: new Date(profile.last_seen),
                        threatLevel: getThreatLevel(profile.description),
                        analysis: analysisText,
                        detectionCount: profile.total_appearances || profile.images.length,
                        allImages: profile.images,
                        firstSeen: profile.first_seen ? new Date(profile.first_seen) : new Date(profile.last_seen)
                    });
                });

                // Sort by timestamp (newest first)
                timelineData.sort((a, b) => b.timestamp - a.timestamp);

                updateStats();
                renderSubjects();

            } catch (error) {
                console.error('Error loading surveillance data:', error);
            }
        }

        function getThreatLevel(description) {
            if (!description) return 'medium';
            const desc = description.toLowerCase();
            if (desc.includes('suspicious') || desc.includes('threat')) return 'high';
            if (desc.includes('unknown')) return 'medium';
            return 'low';
        }

        function generateSarcasticAnalysis() {
            const analyses = [
                "Subject displays alarming tendency to exist in public spaces",
                "Individual exhibits suspicious bipedal locomotion patterns",
                "Person demonstrates concerning ability to breathe oxygen",
                "Subject shows signs of having a face (potential identification risk)",
                "Individual appears to be wearing clothes (hiding something?)",
                "Person exhibits dangerous awareness of surroundings"
            ];
            return analyses[Math.floor(Math.random() * analyses.length)];
        }

        function updateStats() {
            const uniqueSubjects = new Set(timelineData.map(item => item.id)).size;
            const threatCount = timelineData.filter(item => item.threatLevel === 'high').length;

            document.getElementById('total-subjects').textContent = uniqueSubjects;
            document.getElementById('threat-count').textContent = threatCount;
            document.getElementById('privacy-violations').textContent = timelineData.length;
            document.getElementById('ai-analyses').textContent = uniqueSubjects * 2;
            document.getElementById('subject-count').textContent = `${uniqueSubjects} SUBJECTS UNDER SURVEILLANCE`;

            // Update analytics chart
            updateAnalyticsChart();
        }

        function updateAnalyticsChart() {
            const demographics = analyzeDemographics();
            
            // Update gender chart
            updateGenderChart(demographics.gender);
            
            // Update skin tone chart
            updateSkinToneChart(demographics.skin_tone);
        }

        function updateGenderChart(genderData) {
            const canvas = document.getElementById('genderChart');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (Object.values(genderData).reduce((sum, count) => sum + count, 0) === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('NO DATA', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Draw gender pie chart
            drawSinglePieChart(ctx, genderData, 0, 0, canvas.width, canvas.height);
            
            // Update gender legend
            updateGenderLegend(genderData);
        }

        function updateSkinToneChart(skinToneData) {
            const canvas = document.getElementById('skinToneChart');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (Object.values(skinToneData).reduce((sum, count) => sum + count, 0) === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('NO DATA', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Draw skin tone pie chart
            drawSinglePieChart(ctx, skinToneData, 0, 0, canvas.width, canvas.height);
            
            // Update skin tone legend
            updateSkinToneLegend(skinToneData);
        }

        function analyzePersonCategories() {
            const categories = {};

            timelineData.forEach(item => {
                // Use the actual nickname instead of generic categories
                const nickname = item.nickname || 'Unknown Person';

                if (categories[nickname]) {
                    categories[nickname]++;
                } else {
                    categories[nickname] = 1;
                }
            });

            return categories;
        }

        function analyzeDemographics() {
            const demographics = {
                gender: { male: 0, female: 0, unknown: 0 },
                skin_tone: { light: 0, medium: 0, dark: 0, unknown: 0 }
            };

            profilesData.forEach(profile => {
                // Extract gender and skin tone from AI analysis
                if (profile.ai_analysis && profile.ai_analysis.comprehensive_analysis) {
                    const analysis = profile.ai_analysis.comprehensive_analysis;

                    // Count gender
                    const gender = (analysis.gender || 'unknown').toLowerCase();
                    if (demographics.gender[gender] !== undefined) {
                        demographics.gender[gender]++;
                    } else {
                        demographics.gender.unknown++;
                    }

                    // Count skin tone
                    const skinTone = (analysis.skin_tone || 'unknown').toLowerCase();
                    if (demographics.skin_tone[skinTone] !== undefined) {
                        demographics.skin_tone[skinTone]++;
                    } else {
                        demographics.skin_tone.unknown++;
                    }
                }
            });

            return demographics;
        }

        function updateDemographicsDisplay() {
            const demographics = analyzeDemographics();
            const display = document.getElementById('demographicsDisplay');

            if (!display) return;

            let html = '<div style="font-size: 12px;">';

            // Gender breakdown
            html += '<div style="margin-bottom: 10px;"><strong>Gender:</strong><br>';
            Object.entries(demographics.gender).forEach(([key, value]) => {
                if (value > 0) {
                    html += `<span style="margin-right: 10px;">${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}</span>`;
                }
            });
            html += '</div>';

            // Skin tone breakdown
            html += '<div><strong>Skin Tone:</strong><br>';
            Object.entries(demographics.skin_tone).forEach(([key, value]) => {
                if (value > 0) {
                    html += `<span style="margin-right: 10px;">${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}</span>`;
                }
            });
            html += '</div>';

            html += '</div>';
            display.innerHTML = html;
        }

        function generateColors(categories) {
            const colors = {};
            const colorPalette = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
                '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'
            ];

            let colorIndex = 0;
            Object.keys(categories).forEach(nickname => {
                colors[nickname] = colorPalette[colorIndex % colorPalette.length];
                colorIndex++;
            });

            return colors;
        }

        function drawSinglePieChart(ctx, data, x, y, width, height) {
            const centerX = x + width / 2;
            const centerY = y + height / 2;
            const radius = Math.min(width, height) / 3;

            const total = Object.values(data).reduce((sum, count) => sum + count, 0);
            if (total === 0) return;

            const colors = {
                male: '#4ECDC4', female: '#FF6B6B', unknown: '#DDD',
                light: '#F7DC6F', medium: '#DDA0DD', dark: '#85C1E9'
            };

            let currentAngle = 0;

            // Draw pie slices only (no title)
            Object.entries(data).forEach(([category, count]) => {
                if (count > 0) {
                    const sliceAngle = (count / total) * 2 * Math.PI;

                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                    ctx.fillStyle = colors[category] || '#999';
                    ctx.fill();

                    ctx.strokeStyle = '#333';
                    ctx.lineWidth = 1;
                    ctx.stroke();

                    currentAngle += sliceAngle;
                }
            });
        }

        function updateGenderLegend(genderData) {
            const legend = document.getElementById('genderLegend');
            legend.innerHTML = '';

            const colors = {
                male: '#4ECDC4', female: '#FF6B6B', unknown: '#DDD'
            };

            Object.entries(genderData).forEach(([category, count]) => {
                if (count > 0) {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    legendItem.innerHTML = `
                        <div class="legend-color" style="background-color: ${colors[category]}"></div>
                        <span class="legend-label">${category.charAt(0).toUpperCase() + category.slice(1)}</span>
                        <span class="legend-count">${count}</span>
                    `;
                    legend.appendChild(legendItem);
                }
            });
        }

        function updateSkinToneLegend(skinToneData) {
            const legend = document.getElementById('skinToneLegend');
            legend.innerHTML = '';

            const colors = {
                light: '#F7DC6F', medium: '#DDA0DD', dark: '#85C1E9', unknown: '#DDD'
            };

            Object.entries(skinToneData).forEach(([category, count]) => {
                if (count > 0) {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    legendItem.innerHTML = `
                        <div class="legend-color" style="background-color: ${colors[category]}"></div>
                        <span class="legend-label">${category.charAt(0).toUpperCase() + category.slice(1)}</span>
                        <span class="legend-count">${count}</span>
                    `;
                    legend.appendChild(legendItem);
                }
            });
        }

        let profilesData = [];
        let pendingDetections = new Set();

        async function loadProfiles() {
            try {
                const response = await fetch('/api/profiles');
                const newProfiles = await response.json();
                
                // Check for new profiles that weren't in the previous data
                const previousIds = new Set(profilesData.map(p => p.id));
                const newIds = new Set(newProfiles.map(p => p.id));
                
                // Find truly new profiles
                const addedProfiles = newProfiles.filter(p => !previousIds.has(p.id));
                
                // Add pending cards for new detections
                addedProfiles.forEach(profile => {
                    addPendingDetection(profile.id);
                    
                    // Remove from pending after processing delay
                    setTimeout(() => {
                        removePendingDetection(profile.id);
                        profilesData = newProfiles;
                        renderSubjects();
                    }, 2000 + Math.random() * 3000); // 2-5 seconds processing time
                });
                
                // Update profiles data if no new ones
                if (addedProfiles.length === 0) {
                    profilesData = newProfiles;
                    renderSubjects();
                }
                
            } catch (error) {
                console.error('Error loading profiles:', error);
            }
        }

        function addPendingDetection(profileId) {
            pendingDetections.add(profileId);
            renderSubjects();
            
            // Add to activity log
            const activityList = document.getElementById('activity-list');
            const now = new Date();
            const activity = `${now.toLocaleDateString()} ${now.toLocaleTimeString()} - Processing new detection...`;
            
            const newActivity = document.createElement('div');
            newActivity.className = 'activity-item';
            newActivity.textContent = activity;
            activityList.insertBefore(newActivity, activityList.firstChild);
        }

        function removePendingDetection(profileId) {
            pendingDetections.delete(profileId);
        }

        function renderSubjects() {
            const subjectsGrid = document.getElementById('subjects-grid');

            // Create combined content with pending cards first
            let allCards = [];

            // Add pending detection cards
            pendingDetections.forEach(id => {
                allCards.push(`
                    <div class="subject-card pending-detection" data-id="${id}">
                        <div class="pending-overlay">
                            <div class="processing-spinner"></div>
                            <div class="pending-text">PROCESSING...</div>
                        </div>
                        <img src="/static/placeholder.jpg" alt="Processing">
                        <div class="subject-timestamp">${new Date().toLocaleString()}</div>
                        <div class="subject-info">
                            <div class="subject-nickname">ANALYZING...</div>
                            <div class="subject-analysis">AI analysis in progress</div>
                            <div class="demographics-info">
                                <span class="gender-tag">?</span>
                                <span class="skin-tone-tag">?</span>
                            </div>
                            <div class="detection-count">Processing</div>
                        </div>
                        <div class="threat-indicator threat-medium"></div>
                    </div>
                `);
            });

            // Add regular profile cards
            profilesData.forEach((profile, index) => {
                const analysis = profile.ai_analysis?.comprehensive_analysis || {};
                const nickname = analysis.nickname || profile.name;
                const description = analysis.description || profile.description;
                const gender = analysis.gender || 'Unknown';
                const skinTone = analysis.skin_tone || 'Unknown';
                const threatLevel = analysis.threat_level || 'low';

                allCards.push(`
                    <div class="subject-card" 
                         data-id="${profile.id}"
                         data-analysis="${description}"
                         data-threat="${threatLevel}"
                         data-count="${profile.total_appearances}"
                         data-images="${(profile.images || []).join(',')}"
                         data-nickname="${nickname}"
                         data-gender="${gender}"
                         data-skin-tone="${skinTone}"
                         data-index="${index}"
                         onclick="showSubjectDetails('${profile.id}')">
                        <button class="delete-btn" onclick="deleteSubject('${profile.id}', event)" title="Delete subject">√ó</button>
                        <img src="/images/${(profile.images && profile.images[0]) ? profile.images[0].replace('captured_people/', '') : 'placeholder.jpg'}" alt="${nickname}" 
                             onerror="this.src='/static/placeholder.jpg'">
                        <div class="subject-timestamp">${new Date(profile.first_seen).toLocaleString()}</div>
                        <div class="subject-info">
                            <div class="subject-nickname">${nickname}</div>
                            <div class="subject-analysis">${description}</div>
                            <div class="demographics-info">
                                <span class="gender-tag">${gender}</span>
                                <span class="skin-tone-tag">${skinTone}</span>
                            </div>
                            <div class="detection-count">${profile.images.length} images</div>
                        </div>
                        <div class="threat-indicator threat-${threatLevel}"></div>
                    </div>
                `);
            });

            // Show message if no cards at all
            if (allCards.length === 0) {
                subjectsGrid.innerHTML = `
                    <div class="loading-subjects">
                        <div style="text-align: center; padding: 40px 20px;">
                            <div style="font-size: 36px; margin-bottom: 15px;">üëÅÔ∏è</div>
                            <div style="font-size: 14px; font-weight: 700; margin-bottom: 8px;">NO QUALIFIED SUBJECTS</div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 15px;">
                                System monitoring with 80% confidence threshold<br>
                                Requires 1+ images for comprehensive profiling
                            </div>
                            <div style="font-size: 10px; color: #999; font-style: italic;">
                                Walk past the camera to begin surveillance...
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            subjectsGrid.innerHTML = allCards.join('');
        }

        function showAnalysis(event, element) {
            const analysisPopup = document.getElementById('hover-analysis');
            const rect = element.getBoundingClientRect();

            // Position popup
            analysisPopup.style.left = (rect.right + 10) + 'px';
            analysisPopup.style.top = rect.top + 'px';

            // Get profile data
            const profileId = element.dataset.id;
            const profile = timelineData.find(item => item.id === profileId);

            // Populate content
            const mainImage = element.querySelector('img').src;
            document.getElementById('analysis-image').src = mainImage;

            // Set title to nickname from dataset
            let title = element.dataset.nickname || `Subject ${profileId.substring(0, 8)}`;
            document.getElementById('analysis-title').textContent = title;

            // Show comprehensive analysis
            let analysisText = element.dataset.analysis;
            if (analysisText === '[object Object]' || analysisText === 'undefined') {
                analysisText = 'AI analysis in progress...';
            }
            document.getElementById('ai-paranoia').textContent = analysisText;

            // Show visit count
            document.getElementById('detection-count').textContent = element.dataset.count;

            // Populate subject gallery
            const gallery = document.getElementById('subject-gallery');
            const images = element.dataset.images.split(',').slice(0, 6);
            gallery.innerHTML = images.map(img =>
                `<img src="/images/${img.split('/').pop()}" alt="Subject" onerror="this.src='https://placehold.co/200x150/333/fff?text=SUBJECT+IMAGE+NOT+FOUND'">`
            ).join('');

            analysisPopup.style.display = 'block';
        }

        function hideAnalysis() {
            document.getElementById('hover-analysis').style.display = 'none';
        }


        let currentView = 'live'; // 'live' or 'subject'
        let currentSubjectId = null;
        let imageSlideshow = null;

        async function showSubjectDetails(profileId) {
            try {
                const response = await fetch(`/api/profiles/${profileId}`);
                const profile = await response.json();

                currentView = 'subject';
                currentSubjectId = profileId;

                // Hide live feed
                document.querySelector('.feed-container').style.display = 'none';

                // Show subject details in feed area
                const feedArea = document.querySelector('.feed-container').parentElement;
                let subjectView = document.getElementById('subject-view');

                if (!subjectView) {
                    subjectView = document.createElement('div');
                    subjectView.id = 'subject-view';
                    subjectView.className = 'feed-container';
                    feedArea.appendChild(subjectView);
                }

                const analysis = profile.ai_analysis?.comprehensive_analysis || {};
                const nickname = analysis.nickname || profile.name;
                const description = analysis.description || profile.description;
                const gender = analysis.gender || 'Unknown';
                const skinTone = analysis.skin_tone || 'Unknown';
                const activity = analysis.activity || 'Unknown activity';
                const pattern = analysis.pattern || 'No pattern detected';

                // Safety check for images - if API doesn't return images, get them from profilesData
                if (!profile.images || profile.images.length === 0) {
                    const cachedProfile = profilesData.find(p => p.id === profileId);
                    if (cachedProfile && cachedProfile.images && cachedProfile.images.length > 0) {
                        profile.images = cachedProfile.images;
                    } else {
                        console.error('No images found for profile:', profile.id);
                        return;
                    }
                }

                subjectView.innerHTML = `
                    <div class="subject-slideshow" id="subject-slideshow" onclick="returnToLive()">
                        <div class="slideshow-container">
                            <img id="slideshow-image" src="/images/${profile.images[0].replace('captured_people/', '')}" alt="${nickname}">
                            <div class="image-overlay">
                                <div class="overlay-content">
                                    <div class="overlay-header">
                                        <div class="overlay-subject-name">${nickname}</div>
                                        <div class="threat-badge threat-${(analysis.threat_level || 'low').toLowerCase()}">${(analysis.threat_level || 'low').toUpperCase()}</div>
                                    </div>
                                    <div class="overlay-details">
                                        <div class="detail-item">
                                            <span class="label">Gender:</span>
                                            <span class="value gender-${gender.toLowerCase()}">${gender}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="label">Skin Tone:</span>
                                            <span class="value skin-${skinTone.toLowerCase().replace(' ', '-')}">${skinTone}</span>
                                        </div>
                                        <div class="detail-item description">
                                            <span class="label">Analysis:</span>
                                            <span class="value">${description}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                subjectView.style.display = 'block';

                // Initialize slideshow with auto-cycling GIF
                imageSlideshow = {
                    images: profile.images,
                    currentIndex: 0,
                    nickname: profile.nickname,
                    autoInterval: null
                };

                // Start auto-cycling GIF effect
                if (profile.images.length > 1) {
                    imageSlideshow.autoInterval = setInterval(() => {
                        if (!imageSlideshow || !imageSlideshow.images) {
                            return;
                        }
                        imageSlideshow.currentIndex = (imageSlideshow.currentIndex + 1) % imageSlideshow.images.length;
                        const img = document.getElementById('slideshow-image');
                        if (img) {
                            img.src = `/images/${imageSlideshow.images[imageSlideshow.currentIndex].replace('captured_people/', '')}`;
                        }
                    }, 200); // Change image every 0.2 seconds for faster GIF effect
                }

            } catch (error) {
                console.error('Error loading subject details:', error);
            }
        }

        function returnToLive() {
            currentView = 'live';
            currentSubjectId = null;

            // Stop auto-slideshow
            if (imageSlideshow && imageSlideshow.autoInterval) {
                clearInterval(imageSlideshow.autoInterval);
            }
            imageSlideshow = null;

            // Show live feed
            document.querySelector('.feed-container').style.display = 'block';

            // Hide subject view
            const subjectView = document.getElementById('subject-view');
            if (subjectView) {
                subjectView.style.display = 'none';
            }
        }

        function prevImage() {
            if (!imageSlideshow || imageSlideshow.images.length <= 1) return;

            imageSlideshow.currentIndex = (imageSlideshow.currentIndex - 1 + imageSlideshow.images.length) % imageSlideshow.images.length;
            updateSlideshowImage();
        }

        function nextImage() {
            if (!imageSlideshow || imageSlideshow.images.length <= 1) return;

            imageSlideshow.currentIndex = (imageSlideshow.currentIndex + 1) % imageSlideshow.images.length;
            updateSlideshowImage();
        }

        function updateSlideshowImage() {
            const img = document.getElementById('slideshow-image');
            const counter = document.getElementById('image-counter');

            if (img && counter && imageSlideshow) {
                const currentImage = imageSlideshow.images[imageSlideshow.currentIndex];
                if (currentImage) {
                    img.src = `/images/${currentImage.replace('captured_people/', '')}`;
                }
                counter.textContent = `${imageSlideshow.currentIndex + 1} / ${imageSlideshow.images.length}`;
            }
        }

        // Initialize
        updateTime();
        loadProfiles();
        setInterval(updateTime, 1000);
        setInterval(loadProfiles, 5000); // Refresh profiles every 5 seconds
        // Initialize and load initial data (WebSocket disabled for now)
        // connectWebSocket();
        loadSurveillanceData();

        // Keep polling for updates (primary method for now)
        setInterval(loadSurveillanceData, 5000); // Refresh every 5 seconds

        // Placeholder function for slideshow (will implement later)
        function showSubjectSlideshow(item) {
            console.log('Subject clicked:', item.nickname);
            // For now, just show the modal
            showSubjectModal(item);
        }

        // Function to return to live feed
        function returnToLiveFeed() {
            console.log('Returning to live feed');
            // For now, just close any modals
            hideModal();
        }

        // Add real activity based on detections
        function addRealActivity(profile) {
            const nickname = profile.ai_analysis?.comprehensive_analysis?.nickname || profile.name || `Subject ${profile.id.substring(0, 8)}`;
            const now = new Date();
            const date = now.toLocaleDateString();
            const time = now.toLocaleTimeString();
            
            const activityList = document.getElementById('activity-list');
            const activity = `${date} ${time} - ${nickname}`;

            const newActivity = document.createElement('div');
            newActivity.className = 'activity-item';
            newActivity.textContent = activity;

            activityList.insertBefore(newActivity, activityList.firstChild);

            // Keep only last 10 activities
            while (activityList.children.length > 10) {
                activityList.removeChild(activityList.lastChild);
            }
        }

        // Add activity when profiles are loaded
        function updateActivityLog() {
            fetch('/api/profiles')
                .then(response => response.json())
                .then(profiles => {
                    profiles.forEach(profile => {
                        if (Math.random() < 0.05) { // 5% chance per profile
                            addRealActivity(profile);
                        }
                    });
                });
        }

        setInterval(updateActivityLog, 30000); // Update every 30 seconds

        // Function to delete subject
        function deleteSubject(subjectId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }

            if (confirm('Are you sure you want to delete this subject and all associated images?')) {
                fetch(`/api/profiles/${subjectId}`, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (response.ok) {
                            // Remove from timeline data
                            timelineData = timelineData.filter(item => item.id !== subjectId);

                            // Re-render subjects
                            renderSubjects();
                            updateStats();

                            console.log(`Subject ${subjectId} deleted successfully`);
                        } else {
                            console.error('Failed to delete subject');
                            alert('Failed to delete subject');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting subject:', error);
                        alert('Error deleting subject');
                    });
            }
        }

        // Add subject interactions
        function addSubjectInteractions() {
            document.querySelectorAll('.subject-card').forEach(card => {
                card.addEventListener('click', function () {
                    const itemData = {
                        id: this.dataset.id,
                        nickname: this.dataset.nickname,
                        analysis: this.dataset.analysis,
                        detectionCount: this.dataset.count,
                        allImages: this.dataset.images.split(','),
                        threatLevel: this.dataset.threat
                    };
                    showSubjectSlideshow(itemData);
                });
            });
        }

        // Function to show subject modal
        function showSubjectModal(item) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('subject-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'subject-modal';
                modal.className = 'expanded-modal';
                modal.innerHTML = `
                    <div class="expanded-modal-content">
                        <span class="close-modal" onclick="hideModal()">&times;</span>
                        <div class="expanded-card">
                            <div class="expanded-main-image">
                                <img id="modal-main-image" src="" alt="Main view">
                            </div>
                            <div class="expanded-info">
                                <h3 id="modal-nickname" class="expanded-nickname"></h3>
                                <p id="modal-analysis" class="expanded-analysis"></p>
                                <p id="modal-count" class="expanded-count"></p>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Populate modal
            document.getElementById('modal-nickname').textContent = item.nickname;
            document.getElementById('modal-analysis').textContent = item.analysis;
            document.getElementById('modal-count').textContent = `${item.allImages.length} images`;

            // Set main image
            const mainImage = document.getElementById('modal-main-image');
            mainImage.src = `/images/${item.allImages[0].split('/').pop()}`;
            mainImage.onerror = function () { this.src = 'https://placehold.co/200x150/333/fff?text=SUBJECT+IMAGE+NOT+FOUND'; };

            // Start image cycling if multiple images
            if (item.allImages.length > 1) {
                startImageCycling(item.allImages);
            }

            modal.style.display = 'block';
        }

        // Function to hide modal
        function hideModal() {
            const modal = document.getElementById('subject-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Function to start image cycling
        function startImageCycling(images) {
            const mainImage = document.getElementById('modal-main-image');
            let currentIndex = 0;

            // Clear any existing interval
            if (window.modalCyclingInterval) {
                clearInterval(window.modalCyclingInterval);
            }

            // Start cycling every 200ms
            window.modalCyclingInterval = setInterval(() => {
                currentIndex = (currentIndex + 1) % images.length;
                mainImage.src = `/images/${images[currentIndex].split('/').pop()}`;
            }, 200);
        }

        function showExpandedCard(element) {
            const modal = document.getElementById('expanded-card-modal') || createExpandedCardModal();
            const images = element.dataset.images.split(',');
            const nickname = element.dataset.nickname;
            const analysis = element.dataset.analysis;
            const count = element.dataset.count;
            const profileId = element.dataset.id;

            // Populate modal content
            modal.querySelector('.expanded-nickname').textContent = nickname;
            modal.querySelector('.expanded-analysis').textContent = analysis;
            modal.querySelector('.expanded-count').textContent = `${images.length} images`;

            // Set initial main image
            const mainImage = modal.querySelector('#main-expanded-image');
            mainImage.src = `/images/${images[0].split('/').pop()}`;

            // Start image cycling for GIF effect
            startModalImageCycling(modal, images);

            // Show modal
            modal.style.display = 'block';

            // Add ESC key listener
            document.addEventListener('keydown', handleEscKey);
        }

        function createExpandedCardModal() {
            const modal = document.createElement('div');
            modal.id = 'expanded-card-modal';
            modal.className = 'expanded-modal';
            modal.innerHTML = `
                <div class="expanded-modal-content">
                    <span class="close-modal" onclick="closeExpandedCard()">&times;</span>
                    <div class="expanded-card">
                        <div class="expanded-main-image">
                            <img id="main-expanded-image" src="" alt="Main view">
                        </div>
                        <div class="expanded-info">
                            <h3 class="expanded-nickname"></h3>
                            <p class="expanded-analysis"></p>
                            <p class="expanded-count"></p>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            return modal;
        }

        function startModalImageCycling(modal, images) {
            if (images.length <= 1) return; // Skip if only one image

            const mainImage = modal.querySelector('#main-expanded-image');
            let currentIndex = 0;

            // Clear any existing interval
            if (modal.cyclingInterval) {
                clearInterval(modal.cyclingInterval);
            }

            // Start cycling every 200ms for faster GIF effect
            modal.cyclingInterval = setInterval(() => {
                currentIndex = (currentIndex + 1) % images.length;
                mainImage.src = `/images/${images[currentIndex].split('/').pop()}`;
            }, 200);
        }

        function handleEscKey(event) {
            if (event.key === 'Escape') {
                closeExpandedCard();
            }
        }

        function closeExpandedCard() {
            const modal = document.getElementById('expanded-card-modal');
            if (modal) {
                // Stop image cycling
                if (modal.cyclingInterval) {
                    clearInterval(modal.cyclingInterval);
                    modal.cyclingInterval = null;
                }
                modal.style.display = 'none';

                // Remove ESC key listener
                document.removeEventListener('keydown', handleEscKey);
            }
        }

        // Clear logs function
        function clearLogs() {
            if (confirm('Clear all activity logs?')) {
                const activityList = document.getElementById('activity-list');
                activityList.innerHTML = '<div class="activity-item">Logs cleared by user</div>';

                // Add confirmation activity
                setTimeout(() => {
                    const newActivity = document.createElement('div');
                    newActivity.className = 'activity-item';
                    newActivity.textContent = 'System ready for new surveillance activities';
                    activityList.appendChild(newActivity);
                }, 1000);
            }
        }

        // Clear timeline function
        function clearTimeline() {
            if (confirm('Clear all captured subjects from timeline? This will also clear server data.')) {
                // Call API to clear server data
                fetch('/api/clear-timeline', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Clear timeline display
                            const timelineGrid = document.getElementById('timeline-grid');
                            timelineGrid.innerHTML = `
                            <div class="loading-timeline">
                                <div style="text-align: center; padding: 60px 20px;">
                                    <div style="font-size: 48px; margin-bottom: 20px;">üóëÔ∏è</div>
                                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 10px;">TIMELINE CLEARED</div>
                                    <div style="font-size: 14px; color: #666; margin-bottom: 20px;">
                                        All subject data has been purged<br>
                                        System ready for new surveillance operations
                                    </div>
                                </div>
                            </div>
                        `;

                            // Reset stats
                            document.getElementById('total-subjects').textContent = '0';
                            document.getElementById('threat-count').textContent = '0';
                            document.getElementById('privacy-violations').textContent = '0';
                            document.getElementById('ai-analyses').textContent = '0';
                            document.getElementById('subject-count').textContent = '0 SUBJECTS UNDER SURVEILLANCE';

                            // Add activity log entry
                            const activityList = document.getElementById('activity-list');
                            const newActivity = document.createElement('div');
                            newActivity.className = 'activity-item';
                            newActivity.textContent = 'Timeline cleared - all subject data purged from server';
                            activityList.insertBefore(newActivity, activityList.firstChild);

                            console.log('Timeline cleared successfully');
                        } else {
                            alert('Error clearing timeline: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error clearing timeline:', error);
                        alert('Error clearing timeline');
                    });
            }
        }
    </script>
</body>

</html>